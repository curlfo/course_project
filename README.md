## Постановка задачи
Целью эксперимента является получить признаки КТ изображений с помощью одного из классических методов (GLCM) и с помощью нейросетевых автоэнкодеров. После чего проверить качество признаков, решая синтетическую задачу определения возрастной категории пациентов.
 
## Входные данные
Исходными данными является архив из КТ снимков 1370 пациентов двух возрастных групп (18-23, 38-43 года) . Снимки представлены в формате DICOM, для одного пациента могут присутствовать один или несколько снимков. Для удобства проведения экспериментов с трехмерными данными изображения были конвертированы в формат 3D изображений NIFTI. В выборку были включены по одному изображению для каждого пациента, размер выборки сократился до 1100 изображений за счет ошибок конвертации некоторых КТ.
 
## Разработка и реализация алгоритмов
Для решения поставленной задачи был разработан и реализован следующий алгоритм:
- Для каждого КТ изображения был извлечен вектор GLCM признаков. Извлечение было реализовано на основе открытой реализации метода [1, 2], были использованы следующие параметры: dists (1, 2), i_bins (12). Размерность вектора признаков - 288.
- На выборке из 1100 изображений был обучен автоэнкодер, после чего для каждого изображения был извлечен вектор нейросетевых признаков.
- В качестве автоэнкодера использовалась сеть с симметричными блокам энкодера и декодера, каждый из которых состоял из шести пар слоев (Convolution3D слой, MaxPooling3D/UpSampling3D слой). Сеть обучалась 70 эпох, входные КТ изображения были нормализованы и изменены в размере до (128, 128, 128). Размерность вектора признаков - 256. 
- На выборке из 19000 двухмерных изображений был обучен автоэнкодер, после чего для каждого изображения был извлечен вектор нейросетевых признаков. Для обучения и тестов были использованы только 40% средних слоев, так как верхняя и нижняя части легких состоит в основном из тканей и не несет никакой нужной информации. 
В качестве автоэнкодера использовалась сеть с симметричными блокам энкодера и декодера, каждый из которых состоял из семи пар слоев (Convolution3D слой, MaxPooling3D/UpSampling3D слой). Сеть обучалась 75 эпох, входные КТ изображения были нормализованы и изменены в размере до (256, 256). Размерность вектора признаков - 32.
- Для получения оценки качества признаков на основе каждого из трех наборов признаков были обучены классические классификационные модели, решающие синтетическую задачу классификации возрастной группы пациента. 
- Был сформирован и зафиксирован набор из 400 пациентов, сбалансированный по возрасту и полу, после чего на основе каждого типа признаков, полученных из КТ этих пациентов, были обучены классические модели (Random Forest, KNN, AdaBoost, SVM) классификации. Выбор параметров модели осуществлялся с помощью случайного поиска, оценка качества работы моделей осуществлялась с помощью кросс-валидации.

Для реализации алгоритма использовалась библиотека Keras. 

## Нормализация
Также важно упомянуть, что особенностью работы с КТ является нетипичная нормализация данных. В КТ встречается такое понятие как воксель - это единица объема, соответствующая пикселю. Значение вокселей в КТ имеет физическую интерпретацию. Это не относительная яркость. Чем выше плотность ткани, тем выше значение вокселя. Существуют фиксированные диапазоны значений вокселей, описывающих соответствующую ткань. Легкие содержат много воздуха и значение КT близко к -1000. Максимальное же значение вокселя, рассматриваемое для изучения КТ - 500. Таким образом формула нормализации будет выглядеть следующим образом: все значения меньше -1000 приравниваем к -1000, все значения больше 500 к 500.

## Результаты эксперимента
В ходе работы были извлечены два вида признаков КТ изображений, на основе которых были обучены классические классификационные модели: Random Forest, KNN, AdaBoost, SVM. Полученные в результате эксперимента значения точности (accuracy) при обучении данных моделей на  GLCM признаках и признаках, извлеченных автоэнкодером представлены в Таблице 1.
Как видно признаки, полученные при помощи GLCM и 3D автоэнкодером показывают примерно одинаковую точность. А вот признаки, извлеченные из 2D автоэнкодера, показали значительно более низкий результат. На данном этапе трудно сказать в чем причина: в том, что межслойные отношения играют ключевую роль или в том, что была выбрана неудачная архитектура нейросети, из-за чего признаки, извлеченные из нее, были недостаточно хороши. Несмотря на то, что восстановленные декодером картинки выглядели достаточно точно, признаки могли получится слишком грубыми для классических классификаторов.
 
Таблица 1 - Результаты эксперимента
|               | GLCM          | 2D автоэнкодер  | 3D автоэнкодер |
| ------------- |:-------------:| ---------------:| --------------:|
| Random Forest | 0.75          | 0.53            | 0.68           |
| SVM           | 0.78          | 0.57            | 0.85           |
| AdaBoost      | 0.76          | 0.53            | 0.72           |
| KNN           | 0.70          | 0.49            | 0.64           |

## Выводы
Достигнутая точность классификации на основе нейросетевых признаков, полученных из 3D автоэнкодера несколько выше, чем у классической GLCM (0.85 против 0.78), а значит мы можем считать ее достаточно высокой. К сожалению, при помощи 2D автоэнкодера получить признаки соответствующего уровня не удалось. 

<br><br>
[1] Co-occurrence2Dand3D - https://github.com/skliff13/Co-occurrence2Dand3D
<br>
[2] Three-dimensional texture analysis of MRI brain datasets / V. A. Kovalev, F. Kruggel, H.-J. Gertz, D. Y. von Cramon //  IEEE Transactions on Medical Imaging, vol. 20, no. 5, pp. 424-433 - May 2001
